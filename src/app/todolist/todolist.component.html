<div class="todolist-container">
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-content">
      <div class="app-title">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 11L12 14L22 4" stroke="url(#gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 12V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H16" stroke="url(#gradient)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <defs>
            <linearGradient id="gradient" x1="3" y1="3" x2="22" y2="21" gradientUnits="userSpaceOnUse">
              <stop stop-color="#667eea"/>
              <stop offset="1" stop-color="#764ba2"/>
            </linearGradient>
          </defs>
        </svg>
        <h1>TaskMaster</h1>
      </div>
      
      <!-- ✅ MODIFIÉ: Utilisation de l'Observable currentUserEmail$ -->
      <div class="user-section" *ngIf="currentUserEmail$ | async as userEmail">
        <div class="user-info">
          <div class="user-avatar">
            <span>{{ userEmail.substring(0, 2).toUpperCase() }}</span>
          </div>
          <div class="user-details">
            <span class="user-email">{{ userEmail }}</span>
          </div>
        </div>
        <button class="btn-logout" (click)="logout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 17L21 12L16 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Déconnexion
        </button>
      </div>
    </div>
  </div>

  <!-- Background Animation -->
  <div class="animated-background">
    <div class="floating-shape shape-1"></div>
    <div class="floating-shape shape-2"></div>
    <div class="floating-shape shape-3"></div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="content-wrapper">
      <!-- Header Section -->
      <div class="todo-header">
        <div class="header-text">
          <h2>Mes Tâches</h2>
          <p>Gérez vos tâches efficacement</p>
        </div>
        
        <!-- ✅ MODIFIÉ: Utilisation de l'Observable tasksCount$ -->
        <div class="stats-cards">
          <ng-container *ngIf="tasksCount$ | async as counts">
            <div class="stat-card">
              <span class="stat-number">{{ counts.total }}</span>
              <span class="stat-label">Total</span>
            </div>
            <div class="stat-card completed">
              <span class="stat-number">{{ counts.completed }}</span>
              <span class="stat-label">Complétées</span>
            </div>
            <div class="stat-card pending">
              <span class="stat-number">{{ counts.pending }}</span>
              <span class="stat-label">En cours</span>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Add/Edit Task Form -->
      <div class="task-form-card">
        <h3>{{ isEditing ? 'Modifier la tâche' : 'Nouvelle tâche' }}</h3>
        <form class="task-form" (ngSubmit)="submitTask()">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M4 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Titre
              </label>
              <input 
                type="text" 
                class="form-input"
                [(ngModel)]="currentTask.title"
                name="title"
                placeholder="Ex: Terminer le rapport"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 8V12L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                </svg>
                Date limite
              </label>
              <input 
                type="date" 
                class="form-input"
                [(ngModel)]="currentTask.due_date"
                name="due_date"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Description
            </label>
            <textarea 
              class="form-input"
              [(ngModel)]="currentTask.description"
              name="description"
              rows="3"
              placeholder="Décrivez votre tâche..."
            ></textarea>
          </div>

          <div class="form-row">
            <!-- ✅ MODIFIÉ: Priorité de 1 à 5 au lieu de low/medium/high -->
            <div class="form-group">
              <label class="form-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Priorité (1-5)
              </label>
              <select 
                class="form-input"
                [(ngModel)]="currentTask.priority"
                name="priority"
              >
                <option [ngValue]="1">Priorité 1 (Très basse)</option>
                <option [ngValue]="2">Priorité 2 (Basse)</option>
                <option [ngValue]="3">Priorité 3 (Moyenne)</option>
                <option [ngValue]="4">Priorité 4 (Haute)</option>
                <option [ngValue]="5">Priorité 5 (Très haute)</option>
              </select>
            </div>

            <div class="form-group" style="display: flex; align-items: flex-end;">
              <label class="checkbox-label" style="margin-bottom: 0;">
                <input 
                  type="checkbox" 
                  [(ngModel)]="currentTask.is_completed"
                  name="is_completed"
                />
                <span class="checkbox-custom"></span>
                <span>Tâche complétée</span>
              </label>
            </div>
          </div>

          <div class="form-actions">
            <button 
              type="submit" 
              class="btn-primary"
              [disabled]="!currentTask.title"
            >
              <svg *ngIf="!isEditing" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <svg *ngIf="isEditing" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              {{ isEditing ? 'Mettre à jour' : 'Ajouter la tâche' }}
            </button>
            <button 
              *ngIf="isEditing"
              type="button" 
              class="btn-secondary"
              (click)="cancelEdit()"
            >
              Annuler
            </button>
          </div>
        </form>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <div class="filter-buttons">
          <button 
            class="filter-btn"
            [class.active]="filterStatus === 'all'"
            (click)="filterStatus = 'all'"
          >
            Toutes
          </button>
          <button 
            class="filter-btn"
            [class.active]="filterStatus === 'pending'"
            (click)="filterStatus = 'pending'"
          >
            En cours
          </button>
          <button 
            class="filter-btn"
            [class.active]="filterStatus === 'completed'"
            (click)="filterStatus = 'completed'"
          >
            Complétées
          </button>
        </div>
        
        <div class="search-box">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input 
            type="text" 
            placeholder="Rechercher une tâche..."
            [(ngModel)]="searchTerm"
          />
        </div>
      </div>

      <div class="tasks-grid">
        <ng-container *ngIf="allTasks$ | async as tasks">
          <div 
            *ngFor="let task of getFilteredTasks(tasks)"
            class="task-card"
            [class.completed]="task.is_completed"
          >
            <div class="task-header">
              <div class="task-check">
                <label class="checkbox-label">
                  <input 
                    type="checkbox" 
                    [checked]="task.is_completed"
                    (change)="toggleComplete(task)"
                  />
                  <span class="checkbox-custom"></span>
                </label>
              </div>
              
              <div class="task-priority priority-{{ task.priority }}">
                <span class="priority-dot"></span>
                <span class="priority-text">{{ getPriorityLabel(task.priority) }}</span>
              </div>
            </div>

            <div class="task-content">
              <h4 class="task-title">{{ task.title }}</h4>
              <p class="task-description" *ngIf="task.description">
                {{ task.description }}
              </p>
              
              <div class="task-meta" *ngIf="task.due_date">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span [class.overdue]="isOverdue(task)">{{ formatDate(task.due_date) }}</span>
              </div>
            </div>

            <div class="task-actions">
              <button class="btn-icon edit" (click)="editTask(task)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M18.5 2.50001C18.8978 2.10219 19.4374 1.87869 20 1.87869C20.5626 1.87869 21.1022 2.10219 21.5 2.50001C21.8978 2.89784 22.1213 3.4374 22.1213 4.00001C22.1213 4.56262 21.8978 5.10219 21.5 5.50001L12 15L8 16L9 12L18.5 2.50001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button class="btn-icon delete" (click)="deleteTask(task.id)">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 6H5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="empty-state" *ngIf="getFilteredTasks(tasks).length === 0">
            <svg width="120" height="120" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <circle cx="12" cy="12" r="10" stroke="#cbd5e0" stroke-width="2"/>
              <path d="M8 12H16" stroke="#cbd5e0" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h3>Aucune tâche trouvée</h3>
            <p>{{ getEmptyStateMessage() }}</p>
          </div>
        </ng-container>
      </div>
    </div>
  </div>
</div>